// =============================================
// å°é£å½±å“åŸå¸‚å¯è§†åŒ–ç³»ç»Ÿ - ä¿®æ­£æ•°å€¼è®¡ç®—é—®é¢˜ï¼ˆå·²ä¿®å¤feature.geté”™è¯¯ï¼‰
// =============================================

// 1. åŠ è½½å°é£æ•°æ®
var typhoonData = ee.FeatureCollection('projects/typhoon-475407/assets/all_typhoon_impacts_combined');

// 2. ä½¿ç”¨GEEå†…ç½®çš„ä¸­å›½è¾¹ç•Œæ•°æ®
var chinaBoundary = ee.FeatureCollection('USDOS/LSIB_SIMPLE/2017')
  .filter(ee.Filter.eq('country_co', 'CH'));

// 3. æ•°æ®é¢„å¤„ç† - åŸºäºå®é™…æ•°æ®ç»“æ„ï¼ˆä¿®æ­£ï¼šç»Ÿä¸€yearä¸ºå­—ç¬¦ä¸²ï¼Œé¿å…ç­›é€‰é”™è¯¯ï¼‰
function preprocessData() {
  return typhoonData.map(function(feature) {
    // è§£ææ•°å€¼å­—æ®µ
    var windSpeed = ee.Number.parse(feature.get('wind_speed'));
    var intensityCode = ee.Number.parse(feature.get('intensity_code'));
    var pressure = ee.Number.parse(feature.get('pressure'));
    var lat = ee.Number.parse(feature.get('impact_latitude'));
    var lon = ee.Number.parse(feature.get('impact_longitude'));
    // å…³é”®ï¼šå°†yearè½¬ä¸ºå­—ç¬¦ä¸²ï¼Œä¸å¹´åº¦ç­›é€‰å™¨é€‰é¡¹ç±»å‹ä¸€è‡´
    var year = ee.String(feature.get('year'));
    
    // ä½¿ç”¨å¤„ç†åçš„åŸå¸‚åç§°
    var cityName = ee.String(feature.get('city_name_processed'));
    var originalCityName = ee.String(feature.get('city_name'));
    
    // åˆ›å»ºå‡ ä½•ç‚¹
    var point = ee.Geometry.Point([lon, lat]);
    
    return ee.Feature(point, {
      'unique_id': feature.get('unique_id'),
      'typhoon_id': feature.get('typhoon_id'),
      'typhoon_name': feature.get('typhoon_name'),
      'province': feature.get('province'),
      'city_name': cityName,
      'original_city_name': originalCityName,
      'impact_time': feature.get('impact_time'),
      'wind_speed': windSpeed,
      'pressure': pressure,
      'intensity_code': intensityCode,
      'intensity_level': feature.get('intensity_level'),
      'track_point_index': ee.Number.parse(feature.get('track_point_index')),
      'impact_type': feature.get('impact_type'),
      'sequence_in_city': ee.Number.parse(feature.get('sequence_in_city')),
      'year': year
    });
  });
}

// 4. æŒ‰åŸå¸‚ç»Ÿè®¡å°é£å½±å“æ¬¡æ•°ï¼ˆé€»è¾‘æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
function getCityImpactStats() {
  var processedData = preprocessData();
  
  // æŒ‰åŸå¸‚åˆ†ç»„ç»Ÿè®¡ - æ¯ä¸ªå°é£å¯¹æ¯ä¸ªåŸå¸‚åªç®—ä¸€æ¬¡
  var cityStats = processedData
    .distinct(['typhoon_id', 'city_name'])
    .aggregate_array('city_name')
    .distinct()
    .map(function(cityName) {
      var cityRecords = processedData.filter(ee.Filter.eq('city_name', cityName));
      var typhoonCount = cityRecords.distinct('typhoon_id').size();
      var firstRecord = cityRecords.first();
      var maxWindSpeed = cityRecords.aggregate_max('wind_speed');
      var avgIntensity = cityRecords.aggregate_mean('intensity_code');
      
      // è·å–å½±å“è¯¥åŸå¸‚çš„æ‰€æœ‰å°é£åç§°
      var typhoonNames = cityRecords
        .distinct('typhoon_id')
        .aggregate_array('typhoon_name');
      
      // åˆ›å»ºæ˜¾ç¤ºä¿¡æ¯
      var displayInfo = ee.String('åŸå¸‚: ').cat(cityName)
        .cat('\nå½±å“æ¬¡æ•°: ').cat(ee.Number(typhoonCount).format())
        .cat('\næœ€å¤§é£é€Ÿ: ').cat(ee.Number(maxWindSpeed).toInt().format())
        .cat(' m/s')
        .cat('\nå¹³å‡å¼ºåº¦: ').cat(ee.Number(avgIntensity).format())
        .cat(' çº§')
        .cat('\nå½±å“å°é£: ').cat(typhoonNames.slice(0, 3).join(', '));
      
      return ee.Feature(firstRecord.geometry(), {
        'city_name': cityName,
        'original_city_name': firstRecord.get('original_city_name'),
        'impact_count': typhoonCount,
        'max_wind_speed': maxWindSpeed,
        'avg_intensity': avgIntensity,
        'typhoon_names': typhoonNames,
        'display_info': displayInfo,
        'total_records': cityRecords.size()
      });
    });
  
  return ee.FeatureCollection(cityStats);
}

// 5. å¯è§†åŒ–åŸå¸‚å½±å“çƒ­åŠ›å›¾ - é€‚é…130ä¸ªåŸå¸‚æ•°æ®åˆ†å¸ƒ
function visualizeCityImpacts() {
  var cityStats = getCityImpactStats();
  
  print('=== åŸå¸‚å½±å“ç»Ÿè®¡ ===');
  print('æ€»åŸå¸‚æ•°é‡:', cityStats.size());
  
  // è¾“å‡ºå½±å“æ¬¡æ•°åˆ†å¸ƒï¼ˆå¸®ä½ åç»­å¾®è°ƒè‰²é˜¶ï¼‰
  var impactCountStats = cityStats.aggregate_histogram('impact_count');
  print('å„å½±å“æ¬¡æ•°çš„åŸå¸‚æ•°é‡åˆ†å¸ƒ:', impactCountStats);
  
  // æ ¸å¿ƒï¼šåŸºäº130ä¸ªåŸå¸‚çš„å®é™…åˆ†å¸ƒï¼Œè®¾è®¡5çº§è‰²é˜¶
  var styledCities = cityStats.map(function(feature) {
    var impactCount = ee.Number(feature.get('impact_count'));
    var maxWind = ee.Number(feature.get('max_wind_speed'));
    
    // æŒ‰å½±å“æ¬¡æ•°åˆ†é…é¢œè‰²ï¼ŒåŒºåˆ†åº¦æ‹‰æ»¡
    var color = ee.Algorithms.If(impactCount.gte(9), '#800080', // æš—ç´«è‰²-9æ¬¡åŠä»¥ä¸Š
                   ee.Algorithms.If(impactCount.gte(6), '#DC143C', // æ·±çº¢è‰²-6-8æ¬¡
                   ee.Algorithms.If(impactCount.gte(4), '#FF6347', // æ©™çº¢è‰²-4-5æ¬¡
                   ee.Algorithms.If(impactCount.gte(2), '#FFA500', // æ©™è‰²-2-3æ¬¡
                   '#FFFACD')))); // æ·¡é‡‘è‰²-1æ¬¡
    
    // ç‚¹å¤§å°ï¼šç»“åˆé£é€Ÿï¼Œè®©â€œå½±å“æ¬¡æ•°+é£é€Ÿâ€åŒé‡åŒºåˆ†
    var pointSize = ee.Algorithms.If(maxWind.gt(30), 22, // å¼ºå°é£ï¼ˆå¦‚38m/sï¼‰
                       ee.Algorithms.If(maxWind.gt(20), 18, // å°é£/å¼ºçƒ­å¸¦é£æš´
                       ee.Algorithms.If(maxWind.gt(12), 14, // çƒ­å¸¦é£æš´
                       10))); // çƒ­å¸¦ä½å‹/å‡å¼±ä½å‹
    
    return feature.set('style', {
      'color': color,
      'pointSize': pointSize,
      'pointShape': 'circle',
      'fillColor': color + 'A0', // åŠé€æ˜å¡«å……ï¼ˆé¿å…æ²¿æµ·å¯†é›†åŸå¸‚é®æŒ¡ï¼‰
      'fillOpacity': 0.8
    });
  });
  
  Map.addLayer(styledCities.style({styleProperty: 'style'}), {}, 'åŸå¸‚å°é£å½±å“çƒ­åŠ›å›¾');
  
  // æ˜¾ç¤ºå½±å“æœ€ä¸¥é‡çš„15ä¸ªåŸå¸‚ï¼ˆæ–¹ä¾¿æŸ¥çœ‹é«˜å½±å“åŸå¸‚ï¼‰
  var topCities = cityStats
    .sort('impact_count', false)
    .limit(15);
  
  print('å½±å“æœ€ä¸¥é‡çš„15ä¸ªåŸå¸‚:');
  topCities.evaluate(function(cities) {
    if (cities && cities.features) {
      for (var i = 0; i < cities.features.length; i++) {
        var city = cities.features[i];
        print((i + 1) + '. ' + city.properties.city_name + 
              ': ' + city.properties.impact_count + ' æ¬¡å½±å“ | æœ€å¤§é£é€Ÿ: ' + city.properties.max_wind_speed + ' m/s');
      }
    }
  });
  
  return styledCities;
}

// 6. æ·»åŠ ç‚¹å‡»äº¤äº’åŠŸèƒ½ï¼ˆå…³é”®ä¿®æ­£ï¼šee.Listç”¨size()éå†ï¼Œä¸ç”¨length()ï¼‰
function addClickInteraction(cityLayer) {
  Map.onClick(function(coords, leafletEvent) {
    var point = ee.Geometry.Point([coords.lon, coords.lat]);
    var buffer = point.buffer(50000); // 50å…¬é‡ŒèŒƒå›´
    
    var citiesInBuffer = cityLayer.filterBounds(buffer);
    
    var nearestCity = citiesInBuffer
      .map(function(feature) {
        var distance = feature.distance(point);
        return feature.set('distance', distance);
      })
      .sort('distance')
      .first();
    
    nearestCity.evaluate(function(city) {
      if (city && city.properties) {
        // å…³é”®ä¿®æ­£ï¼šee.Listè·å–é•¿åº¦ç”¨size()ï¼Œä¸æ˜¯length()
        var existingPanels = Map.getWidgets();
        for (var i = 0; i < existingPanels.size(); i++) {
          var widget = existingPanels.get(i);
          if (widget.getPosition && widget.getPosition() === 'bottom-right') {
            Map.remove(widget);
          }
        }
        
        var panel = ui.Panel({
          style: {
            position: 'bottom-right',
            padding: '15px',
            backgroundColor: 'white',
            border: '3px solid #FF6B6B',
            maxWidth: '500px',
            fontSize: '14px'
          }
        });
        
        var info = ui.Label({
          value: city.properties.display_info,
          style: {
            fontSize: '14px',
            fontWeight: 'bold',
            whiteSpace: 'pre-line',
            lineHeight: '1.5'
          }
        });
        
        var detailButton = ui.Button({
          label: 'æŸ¥çœ‹è¯¦ç»†å°é£è®°å½•',
          onClick: function() {
            showCityDetailedRecords(city.properties.city_name);
          },
          style: {
            margin: '10px 0px 0px 0px',
            padding: '8px 16px',
            backgroundColor: '#FF6B6B',
            color: 'white',
            fontWeight: 'bold'
          }
        });
        
        panel.add(info);
        panel.add(detailButton);
        Map.add(panel);
      }
    });
  });
}

// 7. æ˜¾ç¤ºåŸå¸‚è¯¦ç»†å°é£è®°å½•ï¼ˆé€»è¾‘æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
function showCityDetailedRecords(cityName) {
  var processedData = preprocessData();
  var cityRecords = processedData.filter(ee.Filter.eq('city_name', cityName));
  
  print('=== ' + cityName + ' è¯¦ç»†å°é£è®°å½• ===');
  
  // æŒ‰å°é£åˆ†ç»„æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
  var typhoonGroups = cityRecords.distinct('typhoon_id');
  
  typhoonGroups.aggregate_array('typhoon_id').evaluate(function(typhoonIds) {
    if (typhoonIds && typhoonIds.length > 0) {
      // ä½¿ç”¨ä¼ ç»Ÿå¾ªç¯å¤„ç†æ¯ä¸ªå°é£
      var processNextTyphoon = function(index) {
        if (index >= typhoonIds.length) return;
        
        var typhoonId = typhoonIds[index];
        var typhoonRecords = cityRecords.filter(ee.Filter.eq('typhoon_id', typhoonId));
        
        typhoonRecords.limit(1).evaluate(function(records) {
          if (records.features && records.features.length > 0) {
            var record = records.features[0].properties;
            
            // è·å–è¯¥å°é£åœ¨è¯¥åŸå¸‚çš„ç»Ÿè®¡
            typhoonRecords.aggregate_max('wind_speed').evaluate(function(maxWind) {
              typhoonRecords.aggregate_array('intensity_level').evaluate(function(intensities) {
                // å»é‡å¼ºåº¦ç­‰çº§
                var uniqueIntensities = [];
                var seen = {};
                for (var j = 0; j < intensities.length; j++) {
                  var level = intensities[j];
                  if (!seen[level]) {
                    seen[level] = true;
                    uniqueIntensities.push(level);
                  }
                }
                
                print((index + 1) + '. å°é£: ' + record.typhoon_name + ' (' + typhoonId + ')');
                print('   æœ€å¤§é£é€Ÿ: ' + maxWind + ' m/s');
                print('   å¼ºåº¦ç­‰çº§: ' + uniqueIntensities.join(', '));
                print('   å½±å“æ—¶é—´: ' + record.impact_time);
                print('   è®°å½•æ¬¡æ•°: ' + intensities.length);
                print('   ---');
                
                // å¤„ç†ä¸‹ä¸€ä¸ªå°é£
                processNextTyphoon(index + 1);
              });
            });
          } else {
            // å¤„ç†ä¸‹ä¸€ä¸ªå°é£
            processNextTyphoon(index + 1);
          }
        });
      };
      
      // å¼€å§‹å¤„ç†ç¬¬ä¸€ä¸ªå°é£
      processNextTyphoon(0);
      
    } else {
      print('æœªæ‰¾åˆ°è¯¥åŸå¸‚çš„å°é£è®°å½•');
    }
  });
}

// 8. å¹´åº¦åˆ†æåŠŸèƒ½ï¼ˆé€»è¾‘æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
function addYearlyAnalysis() {
  var yearPanel = ui.Panel({
    style: {
      position: 'top-right',
      padding: '12px',
      backgroundColor: 'white',
      border: '2px solid #4CAF50'
    }
  });
  
  yearPanel.add(ui.Label('å¹´åº¦ç­›é€‰', {
    fontWeight: 'bold',
    fontSize: '16px',
    margin: '0px 0px 10px 0px',
    color: '#4CAF50'
  }));
  
  var yearSelector = ui.Select({
    items: ['å…¨éƒ¨å¹´ä»½', '2020', '2021', '2022', '2023', '2024'],
    onChange: function(selectedYear) {
      Map.layers().reset();
      if (selectedYear === 'å…¨éƒ¨å¹´ä»½') {
        var cityLayer = visualizeCityImpacts();
        addClickInteraction(cityLayer);
      } else {
        visualizeYearlyImpacts(selectedYear);
      }
      Map.addLayer(chinaBoundary, {color: 'gray', fillColor: '00000000', width: 2}, 'ä¸­å›½è¾¹ç•Œ');
    },
    style: {width: '120px'}
  });
  
  yearPanel.add(yearSelector);
  Map.add(yearPanel);
}

// 9. å¹´åº¦ç‰¹å®šå¯è§†åŒ–ï¼ˆå…³é”®ä¿®æ­£ï¼šListè½¬Featureåå†è°ƒç”¨mapï¼‰
function visualizeYearlyImpacts(year) {
  var processedData = preprocessData();
  // ç­›é€‰æ—¶ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹yearï¼Œä¸preprocessDataè¾“å‡ºä¸€è‡´
  var yearlyData = processedData.filter(ee.Filter.eq('year', year));
  
  // ç”Ÿæˆå¹´åº¦åŸå¸‚ç»Ÿè®¡List
  var yearlyCityStatsList = yearlyData
    .distinct(['typhoon_id', 'city_name'])
    .aggregate_array('city_name')
    .distinct()
    .map(function(cityName) {
      var cityRecords = yearlyData.filter(ee.Filter.eq('city_name', cityName));
      var typhoonCount = cityRecords.distinct('typhoon_id').size();
      var firstRecord = cityRecords.first();
      var maxWindSpeed = cityRecords.aggregate_max('wind_speed');
      
      return ee.Feature(firstRecord.geometry(), {
        'city_name': cityName,
        'impact_count': typhoonCount,
        'max_wind_speed': maxWindSpeed,
        'year': year
      });
    });
  
  // å…³é”®ä¿®æ­£ï¼šå…ˆå°†Listè½¬ä¸ºFeatureCollectionï¼Œå†è°ƒç”¨mapï¼ˆé¿å…feature.geté”™è¯¯ï¼‰
  var yearlyCityStats = ee.FeatureCollection(yearlyCityStatsList);
  
  // ä¸ºå¹´åº¦æ•°æ®è®¾ç½®æ ·å¼
  var styled = yearlyCityStats.map(function(feature) {
    var impactCount = ee.Number(feature.get('impact_count'));
    var maxWind = ee.Number(feature.get('max_wind_speed'));
    
    // ç®€åŒ–çš„ç‚¹å¤§å°è®¾ç½®
    var pointSize = ee.Algorithms.If(maxWind.gt(30), 20,
                       ee.Algorithms.If(maxWind.gt(20), 15,
                       ee.Algorithms.If(maxWind.gt(10), 10,
                       5)));
    
    return feature.set('style', {
      'color': 'FF0000',
      'pointSize': pointSize
    });
  });
  
  Map.addLayer(styled.style({styleProperty: 'style'}), {}, year + 'å¹´å°é£å½±å“');
  
  // å…³é”®ä¿®æ­£ï¼šç»Ÿè®¡åŸå¸‚æ•°é‡æ—¶ç”¨FeatureCollectionçš„size()
  print(year + 'å¹´å½±å“ç»Ÿè®¡:');
  print('å½±å“åŸå¸‚æ•°é‡:', yearlyCityStats.size());
  print('æ€»è®°å½•æ•°:', yearlyData.size());
}

// 10. æ·»åŠ å›¾ä¾‹ - é€‚é…æ–°è‰²é˜¶ï¼Œæ¸…æ™°è¯´æ˜
function addLegend() {
  var legend = ui.Panel({
    style: {
      position: 'bottom-left',
      padding: '15px',
      backgroundColor: 'white',
      border: '2px solid #2196F3',
      maxWidth: '280px' // é€‚é…å›¾ä¾‹æ–‡å­—é•¿åº¦
    }
  });
  
  legend.add(ui.Label('å°é£å½±å“çƒ­åŠ›å›¾ä¾‹', {
    fontWeight: 'bold', 
    fontSize: '18px',
    margin: '0px 0px 10px 0px',
    color: '#2196F3'
  }));
  
  // ä¸è‰²é˜¶ä¸€ä¸€å¯¹åº”ï¼Œæ ‡æ³¨æ˜ç¡®çš„å½±å“æ¬¡æ•°èŒƒå›´
  legend.add(ui.Label('ğŸŸ£ æš—ç´«è‰²: å½±å“9æ¬¡åŠä»¥ä¸Š', {
    color: '#800080', 
    margin: '5px 0px',
    fontSize: '14px'
  }));
  legend.add(ui.Label('ğŸ”´ æ·±çº¢è‰²: å½±å“6-8æ¬¡', {
    color: '#DC143C',
    margin: '5px 0px',
    fontSize: '14px'
  }));
  legend.add(ui.Label('ğŸŸ  æ©™çº¢è‰²: å½±å“4-5æ¬¡', {
    color: '#FF6347',
    margin: '5px 0px',
    fontSize: '14px'
  }));
  legend.add(ui.Label('ğŸŸ¡ æ©™è‰²: å½±å“2-3æ¬¡', {
    color: '#FFA500',
    margin: '5px 0px',
    fontSize: '14px'
  }));
  legend.add(ui.Label('âšª æ·¡é‡‘è‰²: å½±å“1æ¬¡', {
    color: '#FFFACD',
    margin: '5px 0px',
    fontSize: '14px'
  }));
  
  // è¡¥å……ç‚¹å¤§å°è¯´æ˜
  legend.add(ui.Label('â— ç‚¹å¤§å°è¯´æ˜:', {
    margin: '12px 0px 5px 0px',
    fontWeight: 'bold',
    fontSize: '14px'
  }));
  legend.add(ui.Label('  22px: é£é€Ÿ>30m/sï¼ˆå¼ºå°é£ï¼‰', {
    margin: '2px 0px 0px 15px',
    fontSize: '13px'
  }));
  legend.add(ui.Label('  18px: é£é€Ÿ12-30m/sï¼ˆå°é£/çƒ­å¸¦é£æš´ï¼‰', {
    margin: '2px 0px 0px 15px',
    fontSize: '13px'
  }));
  legend.add(ui.Label('  10px: é£é€Ÿâ‰¤12m/sï¼ˆçƒ­å¸¦ä½å‹ï¼‰', {
    margin: '2px 0px 0px 15px',
    fontSize: '13px'
  }));
  
  legend.add(ui.Label('ğŸ’¡ ç‚¹å‡»åŸå¸‚æŸ¥çœ‹è¯¦ç»†å°é£è®°å½•', {
    margin: '12px 0px 0px 0px', 
    fontStyle: 'italic',
    fontSize: '12px',
    color: '#666'
  }));
  
  Map.add(legend);
}

// 11. æ•°æ®éªŒè¯å’Œç»Ÿè®¡ï¼ˆé€»è¾‘æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
function validateData() {
  var processed = preprocessData();
  
  print('=== æ•°æ®éªŒè¯ç»“æœ ===');
  print('æ€»è®°å½•æ•°:', processed.size());
  print('æ¶‰åŠå°é£æ•°é‡:', processed.aggregate_array('typhoon_id').distinct().size());
  print('æ¶‰åŠåŸå¸‚æ•°é‡:', processed.aggregate_array('city_name').distinct().size());
  print('æ•°æ®å¹´ä»½:', processed.aggregate_array('year').distinct().sort());
  
  // å¼ºåº¦ç­‰çº§åˆ†å¸ƒ
  var intensityStats = processed.aggregate_histogram('intensity_level');
  print('å¼ºåº¦ç­‰çº§åˆ†å¸ƒ:', intensityStats);
  
  // çœä»½ç»Ÿè®¡
  var provinceStats = processed.distinct(['typhoon_id', 'province']).aggregate_histogram('province');
  print('å„çœå½±å“å°é£æ•°é‡:', provinceStats);
}

// 12. ä¸»ç¨‹åºï¼ˆé€»è¾‘æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
function main() {
  // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
  Map.setCenter(115, 30, 4);
  
  // æ·»åŠ ä¸­å›½è¾¹ç•Œ
  Map.addLayer(chinaBoundary, {
    color: 'gray',
    fillColor: '00000000',
    width: 2
  }, 'ä¸­å›½è¾¹ç•Œ');
  
  // æ•°æ®éªŒè¯
  validateData();
  
  // å¯è§†åŒ–åŸå¸‚å½±å“
  var cityLayer = visualizeCityImpacts();
  
  // æ·»åŠ äº¤äº’åŠŸèƒ½
  addClickInteraction(cityLayer);
  
  // æ·»åŠ å¹´åº¦åˆ†æ
  addYearlyAnalysis();
  
  // æ·»åŠ å›¾ä¾‹
  addLegend();
}

// è¿è¡Œä¸»ç¨‹åº
main();